<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeneListe - Liste</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid red; padding: 0.4rem 0.6rem; text-align: left; }
    th { background: blue; }
    th button { all: unset; color: white; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
    th img { width: 14px; height: 14px; filter: invert(1); }
  </style>
</head>
<body>
  <h1>Liste des entrées</h1>
  <div id="status">Chargement...</div>
  <button id="add-btn" disabled>Ajouter</button>
  <button id="refresh-btn" disabled>Tout Annuler</button>
  <button id="rerender-btn" disabled>Rafraîchir</button>
  <button id="save-btn" disabled>Enregistrer (modifier)</button>
  <button id="js-btn" disabled>Transformer CSV en JS</button>
  <div style="margin:0.6rem 0; display:flex; gap:0.5rem; flex-wrap:wrap;">
    <input id="filter-gene" type="text" placeholder="Filtre Gene (contient)" />
    <input id="filter-nom" type="text" placeholder="Filtre début Nom" />
    <input id="filter-prenom" type="text" placeholder="Filtre début Prenom" />
    <input id="filter-s" type="text" placeholder="Filtre S (M/F)" />
    <input id="filter-naiss-start" type="text" placeholder="Naiss_AAAA début" />
    <input id="filter-naiss-end" type="text" placeholder="Naiss_AAAA fin" />
  </div>
  <table aria-live="polite" id="table" hidden>
    <thead></thead>
    <tbody></tbody>
  </table>
  <button id="trace-toggle-btn" type="button">Afficher la trace</button>
  <pre id="trace" hidden style="background:#f5f5f5;border:1px solid #ccc;padding:0.5rem;white-space:pre-wrap;max-height:240px;overflow:auto;"></pre>

  <script src="Qui.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const traceEl = document.getElementById('trace');
    const addBtn = document.getElementById('add-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const rerenderBtn = document.getElementById('rerender-btn');
    const saveBtn = document.getElementById('save-btn');
    const jsBtn = document.getElementById('js-btn');
    const filterGeneInput = document.getElementById('filter-gene');
    const filterNomInput = document.getElementById('filter-nom');
    const filterPrenomInput = document.getElementById('filter-prenom');
    const filterSInput = document.getElementById('filter-s');
    const filterNaissStartInput = document.getElementById('filter-naiss-start');
    const filterNaissEndInput = document.getElementById('filter-naiss-end');
    const traceToggleBtn = document.getElementById('trace-toggle-btn');
    const table = document.getElementById('table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    let dataset = { headers: [], rows: [] };
    let sortKey = null;
    let sortAsc = true;
    let filters = { gene: '', nom: '', prenom: '', s: '', naissStart: '', naissEnd: '' };

    function trace(message) {
      const line = `[${new Date().toISOString()}] ${message}`;
      console.log(line);
      traceEl.textContent = `${line}\n${traceEl.textContent}`;
    }

    function setupTraceToggle() {
      traceToggleBtn.textContent = traceEl.hidden ? 'Afficher la trace' : 'Masquer la trace';
      traceToggleBtn.addEventListener('click', () => {
        traceEl.hidden = !traceEl.hidden;
        traceToggleBtn.textContent = traceEl.hidden ? 'Afficher la trace' : 'Masquer la trace';
      });
    }

    function setupFilters() {
      const onFilterChange = () => {
        filters = {
          gene: normalizeFilter(filterGeneInput.value),
          nom: normalizeFilter(filterNomInput.value),
          prenom: normalizeFilter(filterPrenomInput.value),
          s: normalizeSexValue(filterSInput.value),
          naissStart: normalizeYearFilter(filterNaissStartInput.value),
          naissEnd: normalizeYearFilter(filterNaissEndInput.value)
        };
        render(dataset.headers, dataset.rows);
      };
      filterGeneInput.addEventListener('input', onFilterChange);
      filterNomInput.addEventListener('input', onFilterChange);
      filterPrenomInput.addEventListener('input', onFilterChange);
      filterSInput.addEventListener('input', onFilterChange);
      filterNaissStartInput.addEventListener('input', onFilterChange);
      filterNaissEndInput.addEventListener('input', onFilterChange);
    }

    function normalizeFilter(value) {
      return (value ?? '').toString().trim().toLowerCase();
    }

    function normalizeYearFilter(value) {
      return (value ?? '').toString().replace(/\D+/g, '').slice(0, 4);
    }

    function normalizeSexValue(value) {
      const normalized = (value ?? '').toString().toUpperCase().replace(/[^MF]/g, '');
      return normalized.slice(0, 1);
    }

    setupTraceToggle();
    setupFilters();
    trace('QuiListe: script chargé');
    trace(`Contexte: url=${window.location.href}`);
    trace(`Support fetch: ${typeof fetch}`);

    window.addEventListener('error', (event) => {
      trace(`Erreur globale: ${event.message} @${event.filename}:${event.lineno}`);
    });
    window.addEventListener('unhandledrejection', (event) => {
      trace(`Promesse rejetée non gérée: ${event.reason}`);
    });

    setTimeout(() => trace('Timer 0ms exécuté (boucle event OK)'), 0);

    function render(headers, rows) {
      trace('render appelée');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      const idKey = headers.find(h => h.toLowerCase() === 'id');
      const visibleHeaders = headers.filter(h => h !== idKey);
      if ((!sortKey || !visibleHeaders.includes(sortKey)) && visibleHeaders.length) {
        sortKey = visibleHeaders[0];
        sortAsc = true;
      }
      const trHead = document.createElement('tr');
      visibleHeaders.forEach(h => {
        const th = document.createElement('th');
        const btn = document.createElement('button');
        btn.textContent = formatHeaderLabel(h);
        btn.addEventListener('click', () => toggleSort(h));
        const img = document.createElement('img');
        if (sortKey === h) {
          img.src = sortAsc ? 'img/fleche_haut.svg' : 'img/fleche_bas.svg';
        } else {
          img.src = 'img/fleche_vide.svg';
        }
        btn.appendChild(img);
        th.appendChild(btn);
        trHead.appendChild(th);
      });
      const thAction = document.createElement('th');
      thAction.textContent = 'Action';
      trHead.appendChild(thAction);
      thead.appendChild(trHead);

      const filteredRows = applyFilters(rows, headers);
      const displayRows = applySort(filteredRows);

      displayRows.forEach(row => {
        const tr = document.createElement('tr');
        visibleHeaders.forEach(h => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = row[h] ?? '';
          applyDigitConstraints(h, input);
          input.dataset.field = h;
          input.dataset.id = idKey ? row[idKey] : '';
          input.addEventListener('change', () => {
            if (!input.dataset.id) {
              trace('Impossible de mettre à jour: id manquant');
              return;
            }
            saveField(input.dataset.id, h, input.value, td);
          });
          td.appendChild(input);
          tr.appendChild(td);
        });
        const tdAction = document.createElement('td');
        const btnDetail = document.createElement('button');
        btnDetail.textContent = 'Détail';
        btnDetail.addEventListener('click', () => {
          if (!idKey) return;
          window.open(`QuiDetail.html?id=${encodeURIComponent(row[idKey])}`, '_blank');
        });
        tdAction.appendChild(btnDetail);
        tr.appendChild(tdAction);
        tbody.appendChild(tr);
      });
      table.hidden = false;
    }

    function formatHeaderLabel(header) {
      if (header === 'Naiss_MM') return '_MM';
      if (header === 'Naiss_JJ') return '_JJ';
      if (header === 'Deces_MM') return '_MM';
      if (header === 'Deces_JJ') return '_JJ';
      return header;
    }

    function applySort(rows) {
      if (!sortKey) return rows;
      const arr = [...rows];
      arr.sort((a, b) => {
        const va = (a[sortKey] ?? '').toString();
        const vb = (b[sortKey] ?? '').toString();
        const na = Number(va), nb = Number(vb);
        const bothNum = Number.isFinite(na) && Number.isFinite(nb);
        const cmp = bothNum ? na - nb : va.localeCompare(vb, 'fr', { numeric: true, sensitivity: 'base' });
        return sortAsc ? cmp : -cmp;
      });
      return arr;
    }

    function applyFilters(rows, headers) {
      const geneKey = headers.find(h => h.toLowerCase() === 'gene');
      const nomKey = headers.find(h => h.toLowerCase() === 'nom');
      const prenomKey = headers.find(h => h.toLowerCase() === 'prenom');
      const sKey = headers.find(h => h.toLowerCase() === 's');
      const naissKey = headers.find(h => h.toLowerCase() === 'naiss_aaaa');
      const startYear = filters.naissStart ? Number(filters.naissStart) : null;
      const endYear = filters.naissEnd ? Number(filters.naissEnd) : null;
      return rows.filter(row => {
        if (filters.gene && !normalizeFilter(row[geneKey]).includes(filters.gene)) return false;
        if (filters.nom && !normalizeFilter(row[nomKey]).startsWith(filters.nom)) return false;
        if (filters.prenom && !normalizeFilter(row[prenomKey]).startsWith(filters.prenom)) return false;
        if (filters.s && normalizeSexValue(row[sKey]) !== filters.s) return false;
        if (startYear !== null || endYear !== null) {
          const yearValue = normalizeYearFilter(row[naissKey]);
          if (!yearValue) return false;
          const year = Number(yearValue);
          if (!Number.isFinite(year)) return false;
          if (startYear !== null && year < startYear) return false;
          if (endYear !== null && year > endYear) return false;
        }
        return true;
      });
    }

    function toggleSort(key) {
      if (sortKey === key) {
        sortAsc = !sortAsc;
      } else {
        sortKey = key;
        sortAsc = true;
      }
      render(dataset.headers, dataset.rows);
    }

    function applyDigitConstraints(fieldName, input) {
      if (fieldName.endsWith('_AAAA')) {
        input.maxLength = 4;
        input.placeholder = 'AAAA';
        input.inputMode = 'numeric';
        input.pattern = '\\d{0,4}';
        input.style.width = '60px';
        input.addEventListener('keydown', enforceDigitKey);
        input.addEventListener('paste', enforceDigitPaste);
        input.addEventListener('input', () => {
          input.value = input.value.replace(/\\D+/g, '').slice(0, 4);
        });
      } else if (fieldName.endsWith('_MM') || fieldName.endsWith('_JJ')) {
        input.maxLength = 2;
        input.placeholder = fieldName.endsWith('_MM') ? 'MM' : 'JJ';
        input.inputMode = 'numeric';
        input.pattern = '\\d{0,2}';
        input.style.width = '40px';
        input.addEventListener('keydown', enforceDigitKey);
        input.addEventListener('paste', enforceDigitPaste);
        input.addEventListener('input', () => {
          input.value = input.value.replace(/\\D+/g, '').slice(0, 2);
        });
      } else if (fieldName === 'S') {
        input.maxLength = 1;
        input.placeholder = 'M/F';
        input.pattern = '[MF]';
        input.style.width = '40px';
        input.addEventListener('keydown', enforceSexKey);
        input.addEventListener('paste', enforceSexPaste);
        input.addEventListener('input', () => {
          input.value = normalizeSexValue(input.value);
        });
      }
    }

    function enforceDigitKey(e) {
      const allowed = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
      if (allowed.includes(e.key)) return;
      if (!/^[0-9]$/.test(e.key)) {
        e.preventDefault();
      }
    }

    function enforceDigitPaste(e) {
      e.preventDefault();
      const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
      const digits = pasted.replace(/\\D+/g, '');
      const max = e.target.maxLength > 0 ? e.target.maxLength : digits.length;
      const insert = digits.slice(0, max);
      const start = e.target.selectionStart ?? e.target.value.length;
      const end = e.target.selectionEnd ?? e.target.value.length;
      const value = e.target.value;
      e.target.value = value.slice(0, start) + insert + value.slice(end);
      const pos = start + insert.length;
      e.target.setSelectionRange(pos, pos);
      e.target.dispatchEvent(new Event('input'));
    }

    function normalizeSexValue(value) {
      const normalized = (value ?? '').toString().toUpperCase().replace(/[^MF]/g, '');
      return normalized.slice(0, 1);
    }

    function enforceSexKey(e) {
      const allowed = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
      if (allowed.includes(e.key)) return;
      if (!/^[mMfF]$/.test(e.key)) {
        e.preventDefault();
      }
    }

    function enforceSexPaste(e) {
      e.preventDefault();
      const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
      const value = normalizeSexValue(pasted);
      e.target.value = value;
      e.target.dispatchEvent(new Event('input'));
    }

    function saveField(id, field, value, cell) {
      cell.classList.add('saving');
      const idKey = dataset.headers.find(h => h.toLowerCase() === 'id');
      fetch(`/api/row/${encodeURIComponent(id)}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ field, value })
      })
        .then(res => res.json())
        .then(data => {
          if (!data.ok) throw new Error(data.error || 'Mise à jour échouée');
          trace(`Champ ${field} de l'id ${id} mis à jour en mémoire`);
          if (idKey) {
            const row = dataset.rows.find(r => r[idKey] === id);
            if (row) row[field] = value;
          }
        })
        .catch(err => {
          trace(`Erreur mise à jour id=${id}, champ=${field} : ${err.message}`);
          statusEl.textContent = 'Erreur: ' + err.message;
        })
        .finally(() => {
          cell.classList.remove('saving');
        });
    }

    function loadData() {
      trace('Début fetch API /api/data');
      fetch('/api/data')
        .then(res => {
          if (!res.ok) throw new Error('Echec de chargement: ' + res.status);
          trace('Réponse API OK, statut ' + res.status);
          return res.json();
        })
        .then(data => {
          dataset = data;
          trace(`API: ${dataset.rows.length} lignes reçues`);
          statusEl.textContent = '';
          render(dataset.headers, dataset.rows);
          addBtn.disabled = false;
          refreshBtn.disabled = false;
          rerenderBtn.disabled = false;
          saveBtn.disabled = false;
          jsBtn.disabled = false;
        })
        .catch(err => {
          console.error(err);
          statusEl.textContent = 'Erreur: ' + err.message;
          trace('Erreur API: ' + err.message);
        });
    }

    addBtn.addEventListener('click', () => {
      addBtn.disabled = true;
      statusEl.textContent = 'Ajout...';
      fetch('/api/row', { method: 'POST' })
        .then(res => {
          if (!res.ok) throw new Error('Echec ajout: ' + res.status);
          return res.json();
        })
        .then(data => {
          if (!data.ok) throw new Error(data.error || 'Ajout échoué');
          const idKey = dataset.headers.find(h => h.toLowerCase() === 'id');
          if (idKey) {
            dataset.rows.unshift(data.row);
            render(dataset.headers, dataset.rows);
            trace(`Nouvelle ligne ajoutée avec id=${data.row[idKey]}`);
            statusEl.textContent = 'Nouvelle ligne ajoutée.';
          }
        })
        .catch(err => {
          statusEl.textContent = 'Erreur: ' + err.message;
          trace('Erreur ajout: ' + err.message);
        })
        .finally(() => {
          addBtn.disabled = false;
        });
    });

    rerenderBtn.addEventListener('click', () => {
      refreshDataAndRender('Affichage rafraîchi (données mémoire serveur).');
    });

    jsBtn.addEventListener('click', () => {
      jsBtn.disabled = true;
      statusEl.textContent = 'Génération de Qui.js...';
      fetch('/api/export/js', { method: 'POST' })
        .then(res => {
          if (!res.ok) throw new Error('Echec export JS: ' + res.status);
          return res.json();
        })
        .then(data => {
          if (!data.ok) throw new Error(data.error || 'Export JS échoué');
          statusEl.textContent = `Qui.js généré (${data.rows} lignes).`;
          trace('Qui.js régénéré depuis le CSV serveur');
          // Optionnel: charger les données du fichier généré
          if (typeof window.renderJs === 'function') {
            window.renderJs(render);
            trace('Affichage avec données Qui.js');
          }
        })
        .catch(err => {
          statusEl.textContent = 'Erreur: ' + err.message;
          trace('Erreur export JS: ' + err.message);
        })
        .finally(() => {
          jsBtn.disabled = false;
        });
    });

    function refreshDataAndRender(successMsg) {
      statusEl.textContent = 'Rafraîchissement en cours...';
      fetch('/api/data')
        .then(res => {
          if (!res.ok) throw new Error('Echec rafraîchir: ' + res.status);
          return res.json();
        })
        .then(data => {
          dataset = data;
          render(dataset.headers, dataset.rows);
          statusEl.textContent = successMsg;
          trace('Rafraîchir: données rechargées via /api/data');
        })
        .catch(err => {
          statusEl.textContent = 'Erreur: ' + err.message;
          trace('Erreur rafraîchir: ' + err.message);
        });
    }

    // Exposé pour les fenêtres détail afin de rafraîchir la liste après suppression
    window.refreshFromDetail = () => refreshDataAndRender('Rafraîchi suite à une action dans le détail.');

    refreshBtn.addEventListener('click', () => {
      const ok = confirm("Confirmer l'annulation des modifications ?");
      if (!ok) return;
      refreshBtn.disabled = true;
      statusEl.textContent = 'Rechargement...';
      fetch('/api/reload', { method: 'POST' })
        .then(res => {
          if (!res.ok) throw new Error('Echec reload: ' + res.status);
          return res.json();
        })
        .then(data => {
          dataset = data;
          trace(`Reload: ${dataset.rows.length} lignes reçues`);
          statusEl.textContent = 'Rechargé depuis CSV.';
          render(dataset.headers, dataset.rows);
        })
        .catch(err => {
          statusEl.textContent = 'Erreur: ' + err.message;
          trace('Erreur reload: ' + err.message);
        })
        .finally(() => {
          refreshBtn.disabled = false;
        });
    });

    saveBtn.addEventListener('click', () => {
      saveBtn.disabled = true;
      statusEl.textContent = 'Enregistrement...';
      fetch('/api/save', { method: 'POST' })
        .then(res => {
          if (!res.ok) throw new Error('Echec sauvegarde: ' + res.status);
          return res.json();
        })
        .then(data => {
          if (!data.ok) throw new Error(data.error || 'Sauvegarde échouée');
          statusEl.textContent = `Sauvegardé (${data.saved} lignes)`;
          trace('Sauvegarde CSV réussie');
        })
        .catch(err => {
          statusEl.textContent = 'Erreur: ' + err.message;
          trace('Erreur sauvegarde: ' + err.message);
        })
        .finally(() => {
          saveBtn.disabled = false;
        });
    });

    loadData();
  </script>
</body>
</html>



